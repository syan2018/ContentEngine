@using ContentEngine.Core.Utils
@using ContentEngine.Core.DataPipeline.Models
@using LiteDB
@using FieldType = ContentEngine.Core.DataPipeline.Models.FieldType

@if (!Data.Any())
{
    <MudPaper Class="pa-8 text-center" Elevation="0">
        <MudIcon Icon="@Icons.Material.Filled.TableChart" Size="Size.Large" Color="Color.Secondary" Class="mb-4" />
        <MudText Typo="Typo.h6" GutterBottom="true">@EmptyTitle</MudText>
        <MudText Color="Color.Secondary">@EmptyMessage</MudText>
    </MudPaper>
}
else
{
    <MudPaper Elevation="1" Class="@($"rounded-lg {Class}")">
        <MudTable Items="@GetDisplayData()" T="BsonDocument"
                  Hover="true"
                  Striped="true"
                  FixedHeader="true"
                  Height="@Height"
                  Bordered="false">
            <HeaderContent>
                @if (ShowIdColumn)
                {
                    <MudTh Style="width: 80px;">
                        @if (IsReadOnly)
                        {
                            <MudTableSortLabel SortBy="@(new Func<BsonDocument, object>(x => x.TryGetValue("_id", out var id) ? id.ToString() : ""))">
                                ID
                            </MudTableSortLabel>
                        }
                        else
                        {
                            @("ID")
                        }
                    </MudTh>
                }
                @if (Schema?.Fields != null)
                {
                    @foreach (var field in Schema.Fields)
                    {
                        <MudTh>
                            @if (IsReadOnly)
                            {
                                <MudTableSortLabel SortBy="@(new Func<BsonDocument, object>(x => BsonFormUtils.GetDisplayValue(x, field.Name)))">
                                    @field.Name
                                    @if (field.IsRequired)
                                    {
                                        <span class="required-indicator">*</span>
                                    }
                                </MudTableSortLabel>
                            }
                            else
                            {
                                @field.Name
                                @if (field.IsRequired)
                                {
                                    <span class="required-indicator">*</span>
                                }
                            }
                        </MudTh>
                    }
                }
                @if (HasActions)
                {
                    <MudTh Style="@($"width: {GetActionColumnWidth()};")">操作</MudTh>
                }
            </HeaderContent>
            <RowTemplate Context="item">
                @{
                    var itemId = GetDocumentId(item);
                    var isEditing = editingRowId == itemId;
                }
                @if (ShowIdColumn)
                {
                    <MudTd DataLabel="ID" Class="font-weight-medium">
                        @GetRecordId(item)
                    </MudTd>
                }
                @if (Schema?.Fields != null)
                {
                    @foreach (var field in Schema.Fields)
                    {
                        <MudTd DataLabel="@field.Name">
                            @if (IsReadOnly)
                            {
                                @GetFormattedValue(item, field)
                            }
                            else if (AllowInlineEdit && isEditing)
                            {
                                @RenderInlineEditCell(item, field)
                            }
                            else if (AllowInlineEdit && !isEditing)
                            {
                                <div class="inline-edit-cell" @onclick="() => StartInlineEdit(itemId)">
                                    @GetFormattedValue(item, field)
                                    <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Class="edit-hint" />
                                </div>
                            }
                            else
                            {
                                @RenderEditableCell(item, field)
                            }
                        </MudTd>
                    }
                }
                @if (HasActions)
                {
                    <MudTd>
                        <div class="action-buttons">
                            @if (IsReadOnly)
                            {
                                @if (OnViewRecord.HasDelegate)
                                {
                                    <MudTooltip Text="查看">
                                        <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                                      Color="Color.Primary"
                                                      Size="Size.Small"
                                                      OnClick="() => OnViewRecord.InvokeAsync(item)" />
                                    </MudTooltip>
                                }
                                @if (OnEditRecord.HasDelegate)
                                {
                                    <MudTooltip Text="编辑">
                                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                      Color="Color.Secondary"
                                                      Size="Size.Small"
                                                      OnClick="() => OnEditRecord.InvokeAsync(item)" />
                                    </MudTooltip>
                                }
                                @if (OnDeleteRecord.HasDelegate)
                                {
                                    <MudTooltip Text="删除">
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                      Color="Color.Error"
                                                      Size="Size.Small"
                                                      OnClick="() => OnDeleteRecord.InvokeAsync(item)" />
                                    </MudTooltip>
                                }
                            }
                            else if (isEditing)
                            {
                                <MudTooltip Text="保存">
                                    <MudIconButton Icon="@Icons.Material.Filled.Save"
                                                  Color="Color.Success"
                                                  Size="Size.Small"
                                                  OnClick="() => SaveInlineEdit()" />
                                </MudTooltip>
                                <MudTooltip Text="取消">
                                    <MudIconButton Icon="@Icons.Material.Filled.Cancel"
                                                  Color="Color.Secondary"
                                                  Size="Size.Small"
                                                  OnClick="() => CancelInlineEdit()" />
                                </MudTooltip>
                                @if (OnRowRemoved.HasDelegate || OnDeleteRecord.HasDelegate)
                                {
                                    <MudTooltip Text="删除">
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                      Color="Color.Error"
                                                      Size="Size.Small"
                                                      OnClick="@(() => DeleteRow(item))" />
                                    </MudTooltip>
                                }
                            }
                            else if (AllowInlineEdit)
                            {
                                <MudTooltip Text="编辑">
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                  Color="Color.Primary"
                                                  Size="Size.Small"
                                                  OnClick="() => StartInlineEdit(itemId)" />
                                </MudTooltip>
                                @if (OnRowRemoved.HasDelegate || OnDeleteRecord.HasDelegate)
                                {
                                    <MudTooltip Text="删除">
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                      Color="Color.Error"
                                                      Size="Size.Small"
                                                      OnClick="@(() => DeleteRow(item))" />
                                    </MudTooltip>
                                }
                            }
                            else
                            {
                                @if (OnRowRemoved.HasDelegate || OnDeleteRecord.HasDelegate)
                                {
                                    <MudTooltip Text="删除">
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                      Color="Color.Error"
                                                      Size="Size.Small"
                                                      OnClick="@(() => DeleteRow(item))" />
                                    </MudTooltip>
                                }
                            }
                        </div>
                    </MudTd>
                }
            </RowTemplate>
            <PagerContent>
                @if (ShowPagination)
                {
                    <MudTablePager PageSizeOptions="new int[]{5, 10, 25, 50}"
                                   HideRowsPerPage="false"
                                   HidePagination="false"
                                   InfoFormat="{first_item}-{last_item} / {all_items}" />
                }
            </PagerContent>
        </MudTable>
    </MudPaper>
}

@if (ShowRowCount && Data.Any())
{
    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
        @if (MaxDisplayRows.HasValue && Data.Count > MaxDisplayRows.Value)
        {
            <span>显示前@MaxDisplayRows条记录，共 @Data.Count 条</span>
        }
        else
        {
            <span>共 @Data.Count 条记录</span>
        }
    </MudText>
}

@code {
    // 核心参数
    [Parameter] public SchemaDefinition Schema { get; set; } = null!;
    [Parameter] public List<BsonDocument> Data { get; set; } = new();
    
    // 行为控制
    [Parameter] public bool IsReadOnly { get; set; } = true;
    [Parameter] public bool AllowInlineEdit { get; set; } = false;
    
    // 显示控制
    [Parameter] public bool ShowIdColumn { get; set; } = false;
    [Parameter] public bool ShowPagination { get; set; } = true;
    [Parameter] public bool ShowRowCount { get; set; } = true;
    [Parameter] public int? MaxDisplayRows { get; set; }
    
    // 样式控制
    [Parameter] public string Height { get; set; } = "600px";
    [Parameter] public string Class { get; set; } = "";
    
    // 空状态文本
    [Parameter] public string EmptyTitle { get; set; } = "暂无数据";
    [Parameter] public string EmptyMessage { get; set; } = "没有可显示的内容";
    
    // 事件回调
    [Parameter] public EventCallback<BsonDocument> OnRowRemoved { get; set; }
    [Parameter] public EventCallback<BsonDocument> OnRowChanged { get; set; }
    [Parameter] public EventCallback<BsonDocument> OnViewRecord { get; set; }
    [Parameter] public EventCallback<BsonDocument> OnEditRecord { get; set; }
    [Parameter] public EventCallback<BsonDocument> OnDeleteRecord { get; set; }

    // 内部状态
    private string? editingRowId = null;
    private BsonDocument? originalEditingData = null;
    private BsonDocument? editingData = null;

    // 计算属性
    private bool HasActions => OnViewRecord.HasDelegate || OnEditRecord.HasDelegate || OnDeleteRecord.HasDelegate || OnRowRemoved.HasDelegate || !IsReadOnly;

    private IEnumerable<BsonDocument> GetDisplayData()
    {
        if (MaxDisplayRows.HasValue)
        {
            return Data.Take(MaxDisplayRows.Value);
        }
        return Data;
    }

    private string GetDocumentId(BsonDocument document)
    {
        if (document.TryGetValue("_id", out var id))
        {
            return id.ToString();
        }
        return document.GetHashCode().ToString();
    }

    private string GetRecordId(BsonDocument document)
    {
        if (document.TryGetValue("_id", out var id))
        {
            var idStr = id.ToString();
            return idStr.Length > 8 ? idStr.Substring(0, 8) + "..." : idStr;
        }
        return "未知";
    }

    private string GetActionColumnWidth()
    {
        var buttonCount = 0;
        if (IsReadOnly)
        {
            if (OnViewRecord.HasDelegate) buttonCount++;
            if (OnEditRecord.HasDelegate) buttonCount++;
            if (OnDeleteRecord.HasDelegate) buttonCount++;
        }
        else
        {
            if (AllowInlineEdit)
            {
                buttonCount = 2; // 编辑 + 删除 (或 保存 + 取消 + 删除)
            }
            else
            {
                buttonCount = 1; // 删除
            }
        }
        
        return $"{Math.Max(buttonCount * 40, 80)}px";
    }

    private void StartInlineEdit(string documentId)
    {
        var document = Data.FirstOrDefault(d => GetDocumentId(d) == documentId);
        if (document != null)
        {
            editingRowId = documentId;
            originalEditingData = new BsonDocument(document);
            editingData = new BsonDocument(document);
            StateHasChanged();
        }
    }

    private async Task SaveInlineEdit()
    {
        if (editingData != null && originalEditingData != null)
        {
            var originalDocument = Data.FirstOrDefault(d => GetDocumentId(d) == editingRowId);
            if (originalDocument != null)
            {
                originalDocument.Clear();
                foreach (var kvp in editingData)
                {
                    originalDocument[kvp.Key] = kvp.Value;
                }
                await OnRowChanged.InvokeAsync(originalDocument);
            }
        }
        CancelInlineEdit();
    }

    private void CancelInlineEdit()
    {
        editingRowId = null;
        originalEditingData = null;
        editingData = null;
        StateHasChanged();
    }

    private RenderFragment GetFormattedValue(BsonDocument document, FieldDefinition field)
    {
        var value = BsonFormUtils.GetDisplayValue(document, field.Name);
        
        return field.Type switch
        {
            FieldType.Boolean => builder =>
            {
                var boolValue = bool.TryParse(value, out var b) && b;
                builder.OpenComponent<MudChip<string>>(0);
                builder.AddAttribute(1, "Text", boolValue ? "是" : "否");
                builder.AddAttribute(2, "Color", boolValue ? Color.Success : Color.Default);
                builder.AddAttribute(3, "Size", Size.Small);
                builder.AddAttribute(4, "Variant", Variant.Filled);
                builder.CloseComponent();
            },
            FieldType.Date => builder =>
            {
                if (DateTime.TryParse(value, out var date))
                {
                    builder.AddContent(0, date.ToString("yyyy-MM-dd"));
                }
                else
                {
                    builder.AddContent(0, value);
                }
            },
            FieldType.Number => builder =>
            {
                builder.OpenElement(0, "span");
                builder.AddAttribute(1, "class", "font-weight-medium");
                builder.AddContent(2, value);
                builder.CloseElement();
            },
            _ => builder => builder.AddContent(0, value)
        };
    }

    private RenderFragment RenderInlineEditCell(BsonDocument rowData, FieldDefinition field) => __builder =>
    {
        var workingData = editingData ?? rowData;
        
        switch (field.Type)
        {
            case FieldType.Text:
                <MudTextField T="string"
                              Value="@GetCellStringValue(workingData, field.Name)"
                              ValueChanged="@(value => SetInlineEditValue(field.Name, new BsonValue(value)))"
                              Variant="Variant.Text"
                              Margin="Margin.None"
                              Class="inline-edit-field" />
                break;

            case FieldType.Number:
                <MudNumericField T="double?"
                                 Value="@GetCellDoubleValue(workingData, field.Name)"
                                 ValueChanged="@(value => SetInlineEditValue(field.Name, value.HasValue ? new BsonValue(value.Value) : BsonValue.Null))"
                                 Variant="Variant.Text"
                                 Margin="Margin.None"
                                 Class="inline-edit-field" />
                break;

            case FieldType.Boolean:
                <MudCheckBox T="bool"
                             Checked="@GetCellBoolValue(workingData, field.Name)"
                             CheckedChanged="@((bool value) => SetInlineEditValue(field.Name, new BsonValue(value)))"
                             Color="Color.Primary"
                             Size="Size.Small" />
                break;

            case FieldType.Date:
                <MudDatePicker Date="@GetCellDateValue(workingData, field.Name)"
                               DateChanged="@(value => SetInlineEditValue(field.Name, value.HasValue ? new BsonValue(value.Value) : BsonValue.Null))"
                               Variant="Variant.Text"
                               Margin="Margin.None"
                               Class="inline-edit-field" />
                break;

            case FieldType.Reference:
                <MudTextField T="string"
                              Value="@GetCellStringValue(workingData, field.Name)"
                              ValueChanged="@(value => SetInlineEditValue(field.Name, new BsonValue(value)))"
                              Variant="Variant.Text"
                              Margin="Margin.None"
                              Class="inline-edit-field" />
                break;

            default:
                <MudTextField T="string"
                              Value="@GetCellStringValue(workingData, field.Name)"
                              ValueChanged="@(value => SetInlineEditValue(field.Name, new BsonValue(value)))"
                              Variant="Variant.Text"
                              Margin="Margin.None"
                              Class="inline-edit-field" />
                break;
        }
    };

    private RenderFragment RenderEditableCell(BsonDocument rowData, FieldDefinition field) => __builder =>
    {
        switch (field.Type)
        {
            case FieldType.Text:
                <MudTextField T="string"
                              Value="@GetCellStringValue(rowData, field.Name)"
                              ValueChanged="@(value => SetCellValue(rowData, field.Name, new BsonValue(value)))"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense" />
                break;

            case FieldType.Number:
                <MudNumericField T="double?"
                                 Value="@GetCellDoubleValue(rowData, field.Name)"
                                 ValueChanged="@(value => SetCellValue(rowData, field.Name, value.HasValue ? new BsonValue(value.Value) : BsonValue.Null))"
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense" />
                break;

            case FieldType.Boolean:
                <MudCheckBox T="bool"
                             Checked="@GetCellBoolValue(rowData, field.Name)"
                             CheckedChanged="@((bool value) => SetCellValue(rowData, field.Name, new BsonValue(value)))"
                             Color="Color.Primary"
                             Size="Size.Small" />
                break;

            case FieldType.Date:
                <MudDatePicker Date="@GetCellDateValue(rowData, field.Name)"
                               DateChanged="@(value => SetCellValue(rowData, field.Name, value.HasValue ? new BsonValue(value.Value) : BsonValue.Null))"
                               Variant="Variant.Outlined"
                               Margin="Margin.Dense" />
                break;

            case FieldType.Reference:
                <MudTextField T="string"
                              Value="@GetCellStringValue(rowData, field.Name)"
                              ValueChanged="@(value => SetCellValue(rowData, field.Name, new BsonValue(value)))"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense" />
                break;

            default:
                <MudTextField T="string"
                              Value="@GetCellStringValue(rowData, field.Name)"
                              ValueChanged="@(value => SetCellValue(rowData, field.Name, new BsonValue(value)))"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense" />
                break;
        }
    };

    private async Task RemoveRow(BsonDocument row)
    {
        if (Data != null)
        {
            Data.Remove(row);
            await OnRowRemoved.InvokeAsync(row);
        }
        if (editingRowId == GetDocumentId(row))
        {
            CancelInlineEdit();
        }
    }

    private async Task DeleteRow(BsonDocument row)
    {
        if (OnDeleteRecord.HasDelegate)
        {
            await OnDeleteRecord.InvokeAsync(row);
        }
        else if (OnRowRemoved.HasDelegate)
        {
            await RemoveRow(row);
        }
        
        if (editingRowId == GetDocumentId(row))
        {
            CancelInlineEdit();
        }
    }

    private async Task SetCellValue(BsonDocument rowData, string fieldName, BsonValue value)
    {
        rowData[fieldName] = value;
        await OnRowChanged.InvokeAsync(rowData);
    }

    private void SetInlineEditValue(string fieldName, BsonValue value)
    {
        if (editingData != null)
        {
            editingData[fieldName] = value;
            StateHasChanged();
        }
    }

    private string GetCellStringValue(BsonDocument rowData, string fieldName)
    {
        return rowData.TryGetValue(fieldName, out var bsonValue) && !bsonValue.IsNull ? bsonValue.AsString ?? "" : "";
    }

    private double? GetCellDoubleValue(BsonDocument rowData, string fieldName)
    {
        if (rowData.TryGetValue(fieldName, out var bsonValue) && bsonValue.IsNumber)
        {
            return bsonValue.AsDouble;
        }
        return null;
    }

    private bool GetCellBoolValue(BsonDocument rowData, string fieldName)
    {
        if (rowData.TryGetValue(fieldName, out var bsonValue) && bsonValue.IsBoolean)
        {
            return bsonValue.AsBoolean;
        }
        return false;
    }

    private DateTime? GetCellDateValue(BsonDocument rowData, string fieldName)
    {
        if (rowData.TryGetValue(fieldName, out var bsonValue) && bsonValue.IsDateTime)
        {
            return bsonValue.AsDateTime;
        }
        return null;
    }
}

<style>
    .required-indicator {
        color: #F44336;
        margin-left: 4px;
    }

    .action-buttons {
        display: flex;
        gap: 4px;
        align-items: center;
        justify-content: flex-start;
    }

    .action-buttons .mud-icon-button {
        min-width: 32px;
        min-height: 32px;
    }

    .inline-edit-cell {
        cursor: pointer;
        padding: 8px;
        border-radius: 4px;
        transition: background-color 0.2s;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .inline-edit-cell:hover {
        background-color: rgba(0, 0, 0, 0.04);
    }

    .edit-hint {
        opacity: 0;
        transition: opacity 0.2s;
        margin-left: 8px;
    }

    .inline-edit-cell:hover .edit-hint {
        opacity: 0.6;
    }

    .inline-edit-field {
        min-height: auto !important;
    }

    .inline-edit-field .mud-input-root {
        min-height: auto !important;
    }

    .inline-edit-field .mud-input {
        padding: 4px 0 !important;
        font-size: 0.875rem;
        line-height: 1.43;
    }

    .inline-edit-field .mud-input-root-text {
        border: none !important;
        box-shadow: none !important;
    }

    .inline-edit-field .mud-input-root-text:hover {
        border: 1px solid rgba(0, 0, 0, 0.23) !important;
    }

    .inline-edit-field .mud-input-root-text.mud-input-root-focused {
        border: 2px solid #1976d2 !important;
        box-shadow: none !important;
    }
</style>