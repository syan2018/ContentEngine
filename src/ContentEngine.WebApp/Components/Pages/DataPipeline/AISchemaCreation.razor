@page "/ai-schema-creation"
@using ContentEngine.WebApp.Core.DataPipeline.Models
@using ContentEngine.WebApp.Core.DataPipeline.Services
@using ContentEngine.WebApp.Core.Utils
@using Microsoft.SemanticKernel
@using ConfigurableAIProvider.Services.Factories
@using System.Text.RegularExpressions
@using System.Text
@* @inject ISchemaDefinitionService SchemaService *@
@* @inject IAISchemaSuggestionService AIService // Placeholder for AI service injection *@
@inject NavigationManager NavigationManager
@inject Microsoft.Extensions.Localization.IStringLocalizer<AISchemaCreation> Localizer 
@* @inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResources> SharedLocalizer // 如果需要共享资源 *@
@inject IAIKernelFactory AiKernelFactory
@inject ILogger<AISchemaCreation> Logger
@attribute [StreamRendering(true)]
@rendermode InteractiveServer

<PageTitle>@Localizer["PageTitle"]</PageTitle>

<div class="container mt-4">
    <h1>@Localizer["PageTitle"]</h1>
    <p class="text-muted mb-4">@Localizer["PageDescription"]</p>

    <!-- Step Indicator -->
    <div class="steps mb-5">
        <div class="step active">@Localizer["Step1"]</div>
        <div class="step">@Localizer["Step2"]</div>
        <div class="step">@Localizer["Step3"]</div>
    </div>

    <div class="row">
        <div class="col">
             <!-- Basic Information Card -->
            <div class="card mb-4">
                <div class="card-header">
                    @Localizer["SchemaBasicsHeader"]
                </div>
                <div class="card-body">
                    <div class="mb-3 row">
                        <label for="schemaName" class="col-sm-3 col-form-label">@Localizer["SchemaNameLabel"]:</label>
                        <div class="col-sm-9">
                             <input type="text" id="schemaName" class="form-control" @bind="SchemaName" placeholder="@Localizer["SchemaNamePlaceholder"]">
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label for="schemaDesc" class="col-sm-3 col-form-label">@Localizer["SchemaDescLabel"]:</label>
                         <div class="col-sm-9">
                            <input type="text" id="schemaDesc" class="form-control" @bind="SchemaDescription" placeholder="@Localizer["SchemaDescPlaceholder"]">
                         </div>
                    </div>
                </div>
            </div>

            <!-- Prompt Input Card -->
            <div class="card mb-4">
                 <div class="card-header">
                    @Localizer["DataNeedsHeader"]
                </div>
                <div class="card-body">
                    <p>@Localizer["DataNeedsInstruction"]</p>
                    <textarea class="form-control" rows="6" @bind="UserPrompt" placeholder="@Localizer["UserPromptPlaceholder"]"></textarea>
                    <div class="text-end mt-3">
                        <button class="btn btn-primary" @onclick="AnalyzePrompt" disabled="@IsAnalyzing">
                            @if (IsAnalyzing)
                            {
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                <span class="ms-1">@Localizer["AnalyzingStatus"]</span>
                            }
                            else
                            {
                                <i class="bi bi-magic me-1"></i> <!-- Assuming Bootstrap Icons are available -->
                                <span>@Localizer["AnalyzeButton"]</span>
                            }
                        </button>
                    </div>
                </div>
            </div>

             <!-- AI Analysis Result Section -->
            @if (SuggestedSchema != null)
            {
                <div class="ai-section card mb-4">
                     <div class="card-header bg-info-subtle">
                        @Localizer["AIResultHeader"]
                    </div>
                    <div class="card-body">
                        @((MarkupString)FormatSchemaSuggestionHtml(SuggestedSchema))
                         <p class="mt-3 text-muted small">@Localizer["AIRefineInstruction"]</p>
                    </div>
                </div>
            }
             @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                 <div class="alert alert-danger" role="alert">
                    @ErrorMessage
                </div>
            }

            <!-- Navigation / Status Bar -->
            <div class="d-flex justify-content-between mt-4 mb-4">
                 <button class="btn btn-secondary" disabled>@Localizer["PreviousButton"]</button>
                 <button class="btn btn-primary" @onclick="GoToNextStep" disabled="@(SuggestedSchema == null)">@Localizer["NextButton"] <i class="bi bi-arrow-right"></i></button>
            </div>
        </div>
    </div>
</div>

@code {
    private string SchemaName { get; set; } = "";
    private string SchemaDescription { get; set; } = "";
    private string UserPrompt { get; set; } = "";
    private string ErrorMessage { get; set; } = "";
    private bool IsAnalyzing { get; set; } = false;

    private SchemaDefinition? SuggestedSchema { get; set; }

    private async Task AnalyzePrompt()
    {
        IsAnalyzing = true;
        ErrorMessage = string.Empty;
        SuggestedSchema = null;
        StateHasChanged();

        if (string.IsNullOrWhiteSpace(UserPrompt) || string.IsNullOrWhiteSpace(SchemaName))
        {
            ErrorMessage = Localizer["MissingInputError"];
            IsAnalyzing = false;
            StateHasChanged();
            return;
        }

        Kernel? kernel = null;
        try
        {
            Logger.LogInformation("Building Kernel for Agent 'ContentEngineHelper'...");
            kernel = await AiKernelFactory.BuildKernelAsync("ContentEngineHelper");
            if (kernel == null)
            {
                throw new InvalidOperationException("Failed to create the AI Kernel for agent 'ContentEngineHelper'. Check configuration and logs.");
            }
            Logger.LogInformation("Kernel built successfully.");

            if (!kernel.Plugins.Contains("SchemaHelper"))
            {
                 Logger.LogWarning("SchemaHelper plugin not found in the kernel.");
            }

            var arguments = new KernelArguments
            {
                { "description", UserPrompt }
            };

            Logger.LogInformation("Invoking SchemaHelper.SuggestFields function...");
            var result = await kernel.InvokeAsync("SchemaHelper", "SuggestFields", arguments);
            string? suggestionText = result.GetValue<string>()?.Trim();
            Logger.LogDebug("Raw AI suggestion:\n{SuggestionText}", suggestionText);

            if (string.IsNullOrWhiteSpace(suggestionText))
            {
                throw new InvalidOperationException("AI did not provide a suggestion.");
            }

            Logger.LogInformation("Parsing AI suggestion...");
            var parsedFields = ParseSuggestionToFields(suggestionText);
            if (parsedFields == null || parsedFields.Count == 0)
            {
                 throw new FormatException("Could not parse the AI suggestion into fields. Check AI output format or parser logic.");
            }

            SuggestedSchema = new SchemaDefinition
            {
                Name = SchemaName,
                Description = SchemaDescription,
                Fields = parsedFields
            };
             Logger.LogInformation("Schema suggestion parsed successfully. Found {FieldCount} fields.", SuggestedSchema.Fields.Count);

        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during AI schema suggestion process.");
            ErrorMessage = $"{Localizer["AnalysisError"]}: {ex.Message}";
            SuggestedSchema = null;
        }
        finally
        {
            IsAnalyzing = false;
            StateHasChanged();
        }
    }

    private List<FieldDefinition>? ParseSuggestionToFields(string suggestionText)
    {
        var fields = new List<FieldDefinition>();
        var regex = new Regex(@"^- \s*([\w\s]+)\s*\(\s*(\w+)(?::([\w\s]+))?\s*,\s*(\w+)\s*\)", RegexOptions.IgnoreCase | RegexOptions.Multiline);

        var matches = regex.Matches(suggestionText);

        foreach (Match match in matches)
        {
            if (match.Groups.Count >= 5)
            {
                string name = match.Groups[1].Value.Trim();
                string typeStr = match.Groups[2].Value.Trim();
                string? referenceTarget = match.Groups[3].Success ? match.Groups[3].Value.Trim() : null;
                string requiredStr = match.Groups[4].Value.Trim();

                if (Enum.TryParse<FieldType>(typeStr, true, out var fieldType))
                {
                    var fieldDef = new FieldDefinition
                    {
                        Name = name,
                        Type = fieldType,
                        IsRequired = requiredStr.Equals("Required", StringComparison.OrdinalIgnoreCase),
                        ReferenceSchemaName = fieldType == FieldType.Reference ? referenceTarget : null
                    };

                    if (!string.IsNullOrWhiteSpace(fieldDef.Name))
                    {
                         fields.Add(fieldDef);
                    }
                     else {
                         Logger.LogWarning("Parsed field has empty name from line: {Line}", match.Value);
                     }
                }
                else
                {
                     Logger.LogWarning("Could not parse FieldType '{TypeString}' from line: {Line}", typeStr, match.Value);
                }
            }
             else {
                 Logger.LogWarning("Regex did not match expected groups for line: {Line}", match.Value);
             }
        }
        return fields.Count > 0 ? fields : null;
    }

    private string FormatSchemaSuggestionHtml(SchemaDefinition? schema)
    {
        if (schema == null || schema.Fields == null || schema.Fields.Count == 0)
            return $"<p>{Localizer["NoFieldsSuggested"]}</p>";

        var sb = new StringBuilder();
        sb.AppendFormat("<p>{0}</p>", Localizer["AIAnalysisIntro"]);
        sb.AppendLine("<ul>");

        foreach (var field in schema.Fields)
        {
            string typeDisplay = Localizer[$"FieldType{field.Type}"];
            if (field.Type == FieldType.Reference && !string.IsNullOrWhiteSpace(field.ReferenceSchemaName))
            {
                 typeDisplay = Localizer["FieldTypeReferenceLinked", field.ReferenceSchemaName];
            }

            string requiredDisplay = field.IsRequired ? Localizer["FieldRequired"] : Localizer["FieldOptional"];

            sb.AppendFormat("<li><strong>{0}:</strong> {1} ({2})</li>",
                            System.Net.WebUtility.HtmlEncode(field.Name),
                            typeDisplay,
                            requiredDisplay);
        }
        sb.AppendLine("</ul>");
        return sb.ToString();
    }

    private void GoToNextStep()
    {
        if (SuggestedSchema != null)
        {
            Logger.LogInformation("Proceeding to next step with suggested schema: {SchemaName}", SuggestedSchema.Name);
        }
        else
        {
            ErrorMessage = Localizer["ProceedError"];
        }
    }
} 