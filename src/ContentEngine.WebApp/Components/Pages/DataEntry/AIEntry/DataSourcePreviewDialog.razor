@using ContentEngine.Core.DataPipeline.Models
@using ContentEngine.Core.Utils
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <div class="d-flex align-center">
            @GetSourceIcon(DataSource.Type)
            <MudText Typo="Typo.h6" Class="ml-2">é¢„è§ˆ: @DataSource.Name</MudText>
        </div>
    </TitleContent>
    <DialogContent>
        <div class="mb-4">
            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">æ•°æ®æºä¿¡æ¯</MudText>
            <MudGrid Class="mt-2">
                <MudItem xs="6">
                    <MudText Typo="Typo.body2"><strong>ç±»å‹:</strong> @GetSourceTypeText(DataSource.Type)</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2"><strong>å¤§å°:</strong> @GetSourceDescription(DataSource)</MudText>
                </MudItem>
                @if (!string.IsNullOrEmpty(DataSource.MimeType))
                {
                    <MudItem xs="6">
                        <MudText Typo="Typo.body2"><strong>MIMEç±»å‹:</strong> @DataSource.MimeType</MudText>
                    </MudItem>
                }
                @if (!string.IsNullOrEmpty(DataSource.Url))
                {
                    <MudItem xs="12">
                        <MudText Typo="Typo.body2"><strong>URL:</strong> @DataSource.Url</MudText>
                    </MudItem>
                }
                @if (DataSource.HasImages)
                {
                    <MudItem xs="6">
                        <MudText Typo="Typo.body2"><strong>å›¾ç‰‡æ•°é‡:</strong> @DataSource.ImageCount</MudText>
                    </MudItem>
                }
            </MudGrid>
        </div>
        
        <MudDivider Class="mb-4" />
        
        @if (DataSource.HasImages)
        {
            <div class="mb-4">
                <MudButtonGroup Variant="Variant.Outlined" Size="Size.Small">
                    <MudButton Color="@(showImages ? Color.Primary : Color.Default)"
                              OnClick="() => showImages = true"
                              StartIcon="Icons.Material.Filled.Image">
                        åŒ…å«å›¾ç‰‡
                    </MudButton>
                    <MudButton Color="@(!showImages ? Color.Primary : Color.Default)"
                              OnClick="() => showImages = false"
                              StartIcon="Icons.Material.Filled.TextFields">
                        çº¯æ–‡æœ¬
                    </MudButton>
                </MudButtonGroup>
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                    @if (showImages)
                    {
                        <span>æ˜¾ç¤ºåŒ…å«å›¾ç‰‡çš„å®Œæ•´å†…å®¹ï¼ˆAI å¤„ç†æ—¶å¯é€‰æ‹©æ˜¯å¦åŒ…å«ï¼‰</span>
                    }
                    else
                    {
                        <span>æ˜¾ç¤ºçº¯æ–‡æœ¬å†…å®¹ï¼ˆå›¾ç‰‡å·²æ›¿æ¢ä¸ºå ä½ç¬¦ï¼‰</span>
                    }
                </MudText>
            </div>
        }
        
        <div>
            <div class="d-flex align-center justify-space-between mb-3">
                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">
                    @(showImages && DataSource.HasImages ? "å®Œæ•´å†…å®¹" : "æ–‡æœ¬å†…å®¹")
                </MudText>
                <MudChip T="string" Size="Size.Small" Color="Color.Info">
                    @currentContent.Length å­—ç¬¦
                </MudChip>
            </div>
            
            @if (showImages && DataSource.HasImages)
            {
                <div class="mb-4">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="mb-2">å›¾ç‰‡é¢„è§ˆ</MudText>
                    <MudGrid>
                        @foreach (var image in extractedImages)
                        {
                            <MudItem xs="12" sm="6" md="4">
                                <MudCard Outlined="true">
                                    <MudCardContent Class="pa-2">
                                        <div style="text-align: center;">
                                            <img src="@image.DataUri" 
                                                 alt="@image.AltText" 
                                                 style="max-width: 100%; max-height: 200px; object-fit: contain;" />
                                        </div>
                                        <MudText Typo="Typo.caption" Class="mt-2">
                                            <strong>@image.AltText</strong>
                                        </MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @($"{image.MimeType} â€¢ {(image.EstimatedSize / 1024.0):F1} KB")
                                        </MudText>
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                        }
                    </MudGrid>
                </div>
            }
            
            <MudPaper Outlined="true" Class="pa-4" Style="max-height: 400px; overflow-y: auto;">
                <MudText Typo="Typo.body2" Style="white-space: pre-wrap; font-family: 'Consolas', 'Monaco', monospace;">@currentContent</MudText>
            </MudPaper>
            
            @if (currentContent.Length > 1000)
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                    ğŸ’¡ æç¤ºï¼šå†…å®¹è¾ƒé•¿ï¼Œå»ºè®®æ»šåŠ¨æŸ¥çœ‹å®Œæ•´å†…å®¹
                </MudText>
            }
        </div>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Color="Color.Primary">å…³é—­</MudButton>
        <MudButton OnClick="() => CopyToClipboard(currentContent)" 
                  Color="Color.Secondary" 
                  StartIcon="Icons.Material.Filled.ContentCopy">
            å¤åˆ¶å†…å®¹
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public DataSource DataSource { get; set; } = null!;

    private bool showImages = true;
    private List<ImageInfo> extractedImages = new();
    
    private string currentContent => showImages && DataSource.HasImages ? DataSource.Content : DataSource.TextOnlyContent;

    protected override void OnInitialized()
    {
        if (DataSource.HasImages)
        {
            extractedImages = DataUriImageExtractor.ExtractImages(DataSource.Content);
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task CopyToClipboard(string content)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", content);
            Snackbar.Add("å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", Severity.Success);
        }
        catch
        {
            Snackbar.Add("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶", Severity.Warning);
        }
    }

    private RenderFragment GetSourceIcon(DataSourceType type) => type switch
    {
        DataSourceType.File => @<MudIcon Icon="Icons.Material.Filled.InsertDriveFile" Color="Color.Primary" />,
        DataSourceType.Url => @<MudIcon Icon="Icons.Material.Filled.Link" Color="Color.Success" />,
        DataSourceType.Text => @<MudIcon Icon="Icons.Material.Filled.TextFields" Color="Color.Secondary" />,
        _ => @<MudIcon Icon="Icons.Material.Filled.Help" />
    };

    private string GetSourceTypeText(DataSourceType type) => type switch
    {
        DataSourceType.File => "æ–‡ä»¶",
        DataSourceType.Url => "ç½‘é¡µURL",
        DataSourceType.Text => "æ–‡æœ¬å†…å®¹",
        _ => "æœªçŸ¥ç±»å‹"
    };

    private string GetSourceDescription(DataSource source) => source.Type switch
    {
        DataSourceType.File => $"{(source.Size.HasValue ? $"{source.Size.Value / 1024:F1} KB" : "æœªçŸ¥å¤§å°")}",
        DataSourceType.Url => source.Url ?? "URL",
        DataSourceType.Text => $"{source.Content.Length} å­—ç¬¦",
        _ => "æœªçŸ¥ç±»å‹"
    };
}