@page "/"
@using Microsoft.SemanticKernel
@using ConfigurableAIProvider.Services
@inject IAIKernelFactory AiKernelFactory
@attribute [StreamRendering(true)]

<PageTitle>Home</PageTitle>

<h1>Hello, AI world!</h1>

@if (isLoading)
{
    <p><em>Loading AI and Plugin responses...</em></p>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <p style="color: red;">Error: @errorMessage</p>
}
else
{
    <p>AI (Prompt) Response: <strong>@aiResponse</strong></p>
    <hr />
    <p>Test Plugin (C#) Response: <strong>@pluginResponse</strong></p>
    <hr />
    <p>Communicator Plugin (Semantic) Response: <strong>@communicatorResponse</strong></p>
}

Welcome to your new app.

@code {
    private bool isLoading = true;
    private string? aiResponse;
    private string? pluginResponse;
    private string? communicatorResponse;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        try
        {
            var kernel = await AiKernelFactory.BuildKernelAsync("SimpleChat");

            if (kernel == null)
            {
                throw new InvalidOperationException("Failed to create the AI Kernel for agent 'SimpleChat'.");
            }
            
            if (!kernel.Plugins.Contains("TestPlugin"))
            {
                Console.WriteLine("Warning: TestPlugin was not found in the loaded kernel plugins.");
            }
            if (!kernel.Plugins.Contains("Communicator"))
            {
                Console.WriteLine("Warning: Communicator plugin was not found in the loaded kernel plugins.");
            }

            var promptResult = await kernel.InvokePromptAsync("Briefly introduce yourself.");
            aiResponse = promptResult.GetValue<string>();

            try
            {
                var pluginArgs = new KernelArguments
                {
                    ["name"] = "Syan"
                };
                var pluginResult = await kernel.InvokeAsync("TestPlugin", "SayHello", pluginArgs);
                pluginResponse = pluginResult.GetValue<string>();
            }
            catch (Exception ex)
            {
                pluginResponse = $"Error invoking TestPlugin: {ex.Message}";
                Console.WriteLine(ex);
            }

            try
            {
                var commArgs = new KernelArguments
                {
                    { "input", "你好吗？" },
                    { "history", "" }
                };
                var commResult = await kernel.InvokeAsync("Communicator", "ChatWithUser", commArgs);
                communicatorResponse = commResult.GetValue<string>();
            }
            catch (Exception ex)
            {
                communicatorResponse = $"Error invoking Communicator: {ex.Message}";
                Console.WriteLine(ex);
            }

        }
        catch (Exception ex)
        {
            await Console.Error.WriteLineAsync($"Error during AI/Plugin invocation setup: {ex}");
            errorMessage = $"Failed to get responses: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
